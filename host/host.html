<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trivia Host Control Panel</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #e3f2fd 0%,
          #bbdefb 50%,
          #90caf9 100%
        );
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 20px;
      }

      .main-panel {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(66, 165, 245, 0.2);
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .scoreboard,
      .controls-panel,
      .answers-panel {
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(66, 165, 245, 0.2);
      }

      h1,
      h2,
      h3 {
        color: #1565c0;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #e3f2fd;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .connection-status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
      }

      .connection-status.connected {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .connection-status.disconnected {
        background: #ffebee;
        color: #c62828;
      }

      /* Quiz Selector */
      .quiz-selector {
        background: #fff3e0;
        border: 2px solid #ff9800;
        border-radius: 12px;
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .quiz-selector label {
        font-weight: bold;
        color: #e65100;
      }

      .quiz-selector select {
        padding: 10px 15px;
        font-size: 1rem;
        border: 2px solid #ff9800;
        border-radius: 8px;
        background: white;
        color: #e65100;
        cursor: pointer;
        min-width: 200px;
      }

      .quiz-selector button {
        padding: 10px 20px;
        font-size: 1rem;
        background: #ff9800;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      }

      .quiz-selector button:hover {
        background: #f57c00;
      }

      .quiz-loaded {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: bold;
      }

      .quiz-error {
        background: #ffebee;
        color: #c62828;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        width: 100%;
        margin-top: 10px;
      }

      /* Round Title Slide */
      .round-title-slide {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        background: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%);
        border-radius: 15px;
        color: white;
        text-align: center;
        padding: 40px;
      }

      .round-title-slide h2 {
        font-size: 3rem;
        color: white;
        margin-bottom: 10px;
      }

      .round-title-slide .round-number {
        font-size: 1.5rem;
        opacity: 0.9;
      }

      /* Question Display */
      .question-container {
        display: none;
      }

      .question-container.active {
        display: block;
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .question-number {
        background: #1565c0;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
      }

      .question-type {
        background: #e3f2fd;
        color: #1565c0;
        padding: 8px 16px;
        border-radius: 15px;
        font-size: 0.9rem;
      }

      .timer-display {
        font-size: 3.5rem;
        font-weight: bold;
        color: #1565c0;
        text-align: center;
        margin: 20px 0;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .timer-display.countdown {
        color: #ff9800;
      }

      .timer-display.warning {
        color: #f57c00;
      }

      .timer-display.danger {
        color: #d32f2f;
        animation: pulse 0.5s infinite;
      }

      .timer-display.stopped {
        color: #78909c;
      }

      .timer-display.all-answered {
        color: #4caf50;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .question-text {
        font-size: 1.8rem;
        color: #1565c0;
        margin-bottom: 25px;
        line-height: 1.4;
      }

      .question-image {
        width: 100%;
        max-height: 350px;
        object-fit: contain;
        border-radius: 15px;
        margin-bottom: 25px;
        background: #f5f5f5;
      }

      .options-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 25px;
      }

      .option {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 12px;
        font-size: 1.2rem;
        color: #1565c0;
        transition: all 0.3s ease;
      }

      .option.correct {
        background: #4caf50;
        color: white;
        transform: scale(1.02);
      }

      .short-answer-label {
        text-align: center;
        font-size: 1.2rem;
        color: #546e7a;
        margin: 20px 0;
        padding: 20px;
        background: #f5f9ff;
        border-radius: 12px;
      }

      .answer-box {
        background: #e8f5e9;
        border: 3px solid #4caf50;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        display: none;
      }

      .answer-box.visible {
        display: block;
      }

      .answer-box h3 {
        color: #2e7d32;
        margin-bottom: 10px;
      }

      .answer-box .answer-text {
        font-size: 2rem;
        color: #1b5e20;
        font-weight: bold;
      }

      .host-notes {
        background: #fff3e0;
        border-left: 5px solid #ff9800;
        padding: 15px 20px;
        margin-top: 20px;
        border-radius: 0 10px 10px 0;
        display: none;
      }

      .host-notes.visible {
        display: block;
      }

      .host-notes h4 {
        color: #e65100;
        margin-bottom: 8px;
        font-size: 0.9rem;
        text-transform: uppercase;
      }

      .host-notes p {
        color: #5d4037;
        font-size: 1rem;
      }

      /* Control Buttons */
      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 25px;
      }

      button {
        padding: 15px 25px;
        font-size: 1rem;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-primary {
        background: #1565c0;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #0d47a1;
      }

      .btn-success {
        background: #4caf50;
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        background: #388e3c;
      }

      .btn-warning {
        background: #ff9800;
        color: white;
      }

      .btn-warning:hover:not(:disabled) {
        background: #f57c00;
      }

      .btn-danger {
        background: #f44336;
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        background: #d32f2f;
      }

      .btn-secondary {
        background: #78909c;
        color: white;
      }

      .btn-secondary:hover:not(:disabled) {
        background: #546e7a;
      }

      /* Timer Adjustment */
      .timer-adjust {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .timer-adjust label {
        font-weight: bold;
        color: #1565c0;
        min-width: 70px;
      }

      .timer-adjust input {
        width: 80px;
        padding: 10px;
        font-size: 1.2rem;
        border: 2px solid #90caf9;
        border-radius: 8px;
        text-align: center;
      }

      /* Auto-reveal toggle */
      .toggle-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e3f2fd;
      }

      .toggle-container label {
        font-weight: bold;
        color: #1565c0;
        font-size: 0.9rem;
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 26px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      .toggle-switch input:checked + .toggle-slider {
        background-color: #4caf50;
      }

      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }

      /* Scoreboard */
      .scoreboard h2 {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e3f2fd;
      }

      .player-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .player-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin-bottom: 10px;
        background: #f5f9ff;
        border-radius: 10px;
        border-left: 4px solid #1565c0;
      }

      .player-row.leader {
        background: #fff8e1;
        border-left-color: #ffc107;
      }

      .player-info {
        display: flex;
        flex-direction: column;
      }

      .player-name {
        font-weight: bold;
        color: #1565c0;
      }

      .player-status {
        font-size: 0.75rem;
        color: #78909c;
      }

      .player-score {
        font-size: 1.3rem;
        font-weight: bold;
        color: #2e7d32;
      }

      .score-buttons {
        display: flex;
        gap: 3px;
        margin-top: 5px;
      }

      .score-btn {
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 5px;
      }

      /* Answers Panel */
      .answers-panel h3 {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e3f2fd;
      }

      .answer-count {
        text-align: center;
        font-size: 0.9rem;
        color: #1565c0;
        margin-bottom: 10px;
        padding: 8px;
        background: #e3f2fd;
        border-radius: 8px;
      }

      .answer-count.all-in {
        background: #e8f5e9;
        color: #2e7d32;
        font-weight: bold;
      }

      .answers-list {
        max-height: 200px;
        overflow-y: auto;
      }

      .answer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        background: #f5f9ff;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .answer-row .player {
        font-weight: bold;
        color: #1565c0;
      }

      .answer-row .answer {
        color: #37474f;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .answer-row .time {
        color: #90a4ae;
        font-size: 0.8rem;
      }

      .no-answers {
        text-align: center;
        color: #90a4ae;
        padding: 20px;
      }

      /* Progress Bar */
      .progress-container {
        margin-bottom: 20px;
      }

      .progress-bar {
        height: 10px;
        background: #e3f2fd;
        border-radius: 5px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #1565c0, #42a5f5);
        transition: width 0.3s ease;
      }

      .progress-text {
        text-align: center;
        margin-top: 8px;
        color: #1565c0;
        font-weight: bold;
      }

      /* Welcome Screen */
      .welcome-screen {
        text-align: center;
        padding: 60px 40px;
      }

      .welcome-screen h2 {
        font-size: 2.5rem;
        margin-bottom: 20px;
      }

      .welcome-screen p {
        font-size: 1.2rem;
        color: #546e7a;
        margin-bottom: 30px;
      }

      .player-count {
        background: #e3f2fd;
        padding: 15px 30px;
        border-radius: 12px;
        display: inline-block;
        margin-bottom: 30px;
      }

      .player-count span {
        font-size: 2rem;
        font-weight: bold;
        color: #1565c0;
      }

      /* Loading Screen */
      .loading-screen {
        text-align: center;
        padding: 60px 40px;
      }

      .loading-screen .spinner {
        font-size: 4rem;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-bottom: 20px;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 1100px) {
        .container {
          grid-template-columns: 1fr;
        }

        .sidebar {
          flex-direction: row;
          flex-wrap: wrap;
        }

        .sidebar > div {
          flex: 1;
          min-width: 280px;
        }

        .options-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="main-panel">
        <div class="header">
          <h1>üéØ Trivia Night</h1>
          <p>Host Control Panel</p>
          <span class="connection-status disconnected" id="connectionStatus"
            >‚óè Connecting...</span
          >
        </div>

        <!-- Quiz Selector -->
        <div class="quiz-selector" id="quizSelector">
          <label for="quizFile">üìÅ Quiz File:</label>
          <select id="quizFile">
            <option value="questions.js">Default Quiz (questions.js)</option>
            <option value="questions-2025.js">2025 Year in Review</option>
            <option value="questions-sports.js">Sports Special</option>
            <option value="questions-movies.js">Movies & Entertainment</option>
            <option value="custom">Custom file...</option>
          </select>
          <input
            type="text"
            id="customQuizFile"
            placeholder="Enter filename..."
            style="
              display: none;
              padding: 10px;
              border: 2px solid #ff9800;
              border-radius: 8px;
            "
          />
          <button onclick="loadQuizFile()">Load Quiz</button>
          <span class="quiz-loaded" id="quizLoadedStatus" style="display: none"
            >‚úì Loaded</span
          >
          <div class="quiz-error" id="quizError" style="display: none"></div>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progressFill"
              style="width: 0%"
            ></div>
          </div>
          <div class="progress-text" id="progressText">Ready to Start</div>
        </div>

        <div id="quizContent">
          <div class="loading-screen" id="loadingScreen">
            <div class="spinner">‚è≥</div>
            <h2>Select a quiz file to begin</h2>
            <p>Choose a quiz from the dropdown above and click "Load Quiz"</p>
          </div>
        </div>

        <div class="button-group" id="mainControls" style="display: none">
          <button class="btn-warning" onclick="skipTimer()" id="skipTimerBtn">
            ‚è≠Ô∏è Skip Timer
          </button>
          <button class="btn-success" onclick="revealAnswer()" id="revealBtn">
            ‚úÖ Reveal Answer
          </button>
          <button class="btn-primary" onclick="nextItem()" id="nextBtn">
            ‚û°Ô∏è Next
          </button>
          <button class="btn-secondary" onclick="previousItem()">
            ‚¨ÖÔ∏è Previous
          </button>
          <button class="btn-danger" onclick="resetQuiz()">
            üîÑ Reset Quiz
          </button>
        </div>
      </div>

      <div class="sidebar">
        <div class="controls-panel">
          <h3>‚è±Ô∏è Timer Settings</h3>
          <div class="timer-adjust">
            <label>Default:</label>
            <input
              type="number"
              id="defaultTimer"
              value="20"
              min="5"
              max="120"
            />
            <span>sec</span>
          </div>
          <div class="timer-adjust">
            <label>This Q:</label>
            <input
              type="number"
              id="currentTimer"
              value="20"
              min="5"
              max="120"
            />
            <span>sec</span>
          </div>
          <button
            class="btn-primary"
            onclick="manualStartTimer()"
            style="width: 100%; margin-top: 10px"
          >
            ‚ñ∂Ô∏è Manual Start Timer
          </button>

          <!-- Auto-reveal toggle -->
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="autoRevealToggle" checked />
              <span class="toggle-slider"></span>
            </label>
            <label for="autoRevealToggle">Auto-reveal when all answer</label>
          </div>
        </div>

        <div class="answers-panel">
          <h3>üì• Live Answers (Q<span id="currentQNum">-</span>)</h3>
          <div class="answer-count" id="answerCount">0 / 0 answered</div>
          <div class="answers-list" id="answersList">
            <div class="no-answers">Waiting for answers...</div>
          </div>
        </div>

        <div class="scoreboard">
          <h2>üèÜ Scoreboard</h2>
          <div class="player-list" id="playerList">
            <div class="no-answers">No players yet</div>
          </div>
          <button
            class="btn-warning"
            onclick="syncScoresToPlayers()"
            style="width: 100%; margin-top: 15px"
          >
            üì§ Push Scores to Players
          </button>
          <button
            class="btn-danger score-btn"
            onclick="clearAllPlayers()"
            style="width: 100%; margin-top: 10px"
          >
            üóëÔ∏è Clear All Players
          </button>
        </div>
      </div>
    </div>

    <!-- Load external quiz data -->
    <script id="quizDataScript"></script>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBwkOu1jD4SQTzv0gp37ZKR8aNnWvyukao",
        authDomain: "trivia-night-e9193.firebaseapp.com",
        databaseURL:
          "https://trivia-night-e9193-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "trivia-night-e9193",
        storageBucket: "trivia-night-e9193.firebasestorage.app",
        messagingSenderId: "349782633448",
        appId: "1:349782633448:web:3d3bd27620a1021dfc125d",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Quiz Data - will be loaded from external file
      let quizData = [];
      let quizLoaded = false;

      // State
      let currentIndex = -1;
      let timerInterval = null;
      let countdownInterval = null;
      let timeRemaining = 0;
      let answerRevealed = false;
      let players = {};
      let currentAnswers = {};
      let autoRevealTimeout = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        setupFirebaseListeners();
        setupQuizSelector();
      });

      // Quiz file selector logic
      function setupQuizSelector() {
        const select = document.getElementById("quizFile");
        const customInput = document.getElementById("customQuizFile");

        select.addEventListener("change", () => {
          if (select.value === "custom") {
            customInput.style.display = "inline-block";
          } else {
            customInput.style.display = "none";
          }
        });
      }

      function loadQuizFile() {
        const select = document.getElementById("quizFile");
        const customInput = document.getElementById("customQuizFile");
        const errorDiv = document.getElementById("quizError");
        const loadedStatus = document.getElementById("quizLoadedStatus");

        let filename = select.value;
        if (filename === "custom") {
          filename = customInput.value.trim();
          if (!filename) {
            errorDiv.textContent = "‚ö†Ô∏è Please enter a filename";
            errorDiv.style.display = "block";
            return;
          }
          // Add .js extension if not present
          if (!filename.endsWith(".js")) {
            filename += ".js";
          }
        }

        // Hide previous status
        errorDiv.style.display = "none";
        loadedStatus.style.display = "none";

        // Reset quizData
        window.quizData = [];

        // Show loading
        document.getElementById("quizContent").innerHTML = `
        <div class="loading-screen">
            <div class="spinner">‚è≥</div>
            <h2>Loading quiz...</h2>
            <p>Loading ${filename}</p>
        </div>
    `;

        // Create a new script element
        const oldScript = document.getElementById("quizDataScript");
        if (oldScript) {
          oldScript.remove();
        }

        const script = document.createElement("script");
        script.id = "quizDataScript";

        script.onload = () => {
          console.log("Script loaded. quizData:", typeof quizData, quizData);

          if (
            typeof quizData !== "undefined" &&
            Array.isArray(quizData) &&
            quizData.length > 0
          ) {
            quizLoaded = true;
            loadedStatus.style.display = "inline-block";
            loadedStatus.textContent = `‚úì Loaded (${quizData.length} items)`;
            showWelcomeScreen();
          } else {
            let errorMsg = "‚ö†Ô∏è Quiz file loaded but ";
            if (typeof quizData === "undefined") {
              errorMsg +=
                "quizData variable is not defined. Make sure your file starts with: const quizData = [";
            } else if (!Array.isArray(quizData)) {
              errorMsg += "quizData is not an array. Type: " + typeof quizData;
            } else {
              errorMsg += "quizData array is empty.";
            }
            errorDiv.textContent = errorMsg;
            errorDiv.style.display = "block";
            showLoadingScreen();

            // Log for debugging
            console.error("Quiz load error:", errorMsg);
            console.log("quizData value:", quizData);
          }
        };

        script.onerror = (e) => {
          console.error("Script load error:", e);
          errorDiv.textContent = `‚ö†Ô∏è Could not load "${filename}". Make sure the file exists in the same folder as host.html`;
          errorDiv.style.display = "block";
          showLoadingScreen();
        };

        script.src = filename;
        document.body.appendChild(script);
      }

      function showLoadingScreen() {
        document.getElementById("quizContent").innerHTML = `
                <div class="loading-screen" id="loadingScreen">
                    <div class="spinner">‚è≥</div>
                    <h2>Select a quiz file to begin</h2>
                    <p>Choose a quiz from the dropdown above and click "Load Quiz"</p>
                </div>
            `;
      }

      function showWelcomeScreen() {
        document.getElementById("quizContent").innerHTML = `
                <div class="welcome-screen" id="welcomeScreen">
                    <h2>Welcome to Trivia Night! üéâ</h2>
                    <p>Quiz loaded with ${
                      quizData.length
                    } items. Wait for players to join, then click "Start Quiz" to begin.</p>
                    <div class="player-count">
                        <span id="playerCountDisplay">${
                          Object.keys(players).length
                        }</span> players connected
                    </div>
                    <br><br>
                    <button class="btn-primary" onclick="startQuiz()" style="font-size: 1.3rem; padding: 20px 40px;">
                        üöÄ Start Quiz
                    </button>
                </div>
            `;
      }

      function setupFirebaseListeners() {
        // Connection status
        db.ref(".info/connected").on("value", (snap) => {
          const status = document.getElementById("connectionStatus");
          if (snap.val() === true) {
            status.textContent = "‚óè Connected";
            status.className = "connection-status connected";
          } else {
            status.textContent = "‚óè Disconnected";
            status.className = "connection-status disconnected";
          }
        });

        // Listen for players
        db.ref("players").on("value", (snap) => {
          players = snap.val() || {};
          renderPlayers();
          updatePlayerCount();
          checkAllAnswered();
        });

        // Listen for answers
        db.ref("answers").on("value", (snap) => {
          const answers = snap.val() || {};
          renderAnswers(answers);
          checkAllAnswered();
        });
      }

      function updatePlayerCount() {
        const count = Object.keys(players).length;
        const countDisplay = document.getElementById("playerCountDisplay");
        if (countDisplay) {
          countDisplay.textContent = count;
        }
      }

      function getOnlinePlayerCount() {
        return Object.values(players).filter((p) => p.online).length;
      }

      function getCurrentAnswerCount() {
        const item = quizData[currentIndex];
        if (!item || item.type !== "question") return 0;

        const qNum = item.questionNumber;
        return Object.keys(currentAnswers[qNum] || {}).length;
      }

      function checkAllAnswered() {
        const item = quizData[currentIndex];
        if (!item || item.type !== "question" || answerRevealed) {
          return;
        }

        const autoRevealEnabled =
          document.getElementById("autoRevealToggle").checked;
        if (!autoRevealEnabled) {
          return;
        }

        const onlineCount = getOnlinePlayerCount();
        const answerCount = getCurrentAnswerCount();

        updateAnswerCountDisplay(answerCount, onlineCount);

        if (onlineCount > 0 && answerCount >= onlineCount) {
          if (autoRevealTimeout) {
            clearTimeout(autoRevealTimeout);
          }

          const timerDisplay = document.getElementById("timerDisplay");
          if (timerDisplay && !answerRevealed) {
            timerDisplay.textContent = "All answered! Revealing in 2s...";
            timerDisplay.className = "timer-display all-answered";
          }

          autoRevealTimeout = setTimeout(() => {
            if (!answerRevealed) {
              revealAnswer();
            }
          }, 2000);
        }
      }

      function updateAnswerCountDisplay(answerCount, onlineCount) {
        const countEl = document.getElementById("answerCount");
        countEl.textContent = `${answerCount} / ${onlineCount} answered`;

        if (answerCount >= onlineCount && onlineCount > 0) {
          countEl.classList.add("all-in");
        } else {
          countEl.classList.remove("all-in");
        }
      }

      function startQuiz() {
        if (!quizLoaded || quizData.length === 0) {
          alert("Please load a quiz file first!");
          return;
        }

        document.getElementById("welcomeScreen").style.display = "none";
        document.getElementById("mainControls").style.display = "flex";
        document.getElementById("quizSelector").style.display = "none";
        currentIndex = 0;

        syncGameState();
        renderCurrentItem();
      }

      function syncGameState() {
        const item = quizData[currentIndex];
        let gameState = {
          currentIndex: currentIndex,
          status: "active",
          answerRevealed: answerRevealed,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
        };

        if (item) {
          if (item.type === "round-title") {
            gameState.type = "round-title";
            gameState.roundNumber = item.roundNumber;
            gameState.roundTitle = item.title;
          } else {
            gameState.type = "question";
            gameState.questionNumber = item.questionNumber;
            gameState.questionType = item.questionType;
            gameState.questionText = item.text;
            gameState.questionImage = item.image || null;
            gameState.options = item.options || null;
            if (answerRevealed) {
              gameState.answer = item.answer;
            }
          }
        }

        db.ref("gameState").set(gameState);
      }

      function renderCurrentItem() {
        if (currentIndex < 0 || currentIndex >= quizData.length) return;

        const item = quizData[currentIndex];
        const content = document.getElementById("quizContent");
        answerRevealed = false;
        clearInterval(timerInterval);
        clearInterval(countdownInterval);

        if (autoRevealTimeout) {
          clearTimeout(autoRevealTimeout);
          autoRevealTimeout = null;
        }

        const progress = ((currentIndex + 1) / quizData.length) * 100;
        document.getElementById("progressFill").style.width = progress + "%";
        document.getElementById("progressText").textContent = `Item ${
          currentIndex + 1
        } of ${quizData.length}`;

        document.getElementById("currentTimer").value =
          item.timer || document.getElementById("defaultTimer").value;

        if (item.type === "question") {
          document.getElementById("currentQNum").textContent =
            item.questionNumber;
          updateAnswerCountDisplay(0, getOnlinePlayerCount());
        } else {
          document.getElementById("currentQNum").textContent = "-";
          updateAnswerCountDisplay(0, 0);
        }

        if (item.type === "round-title") {
          content.innerHTML = `
                    <div class="round-title-slide">
                        <div class="round-number">ROUND ${item.roundNumber}</div>
                        <h2>${item.title}</h2>
                    </div>
                `;
          syncGameState();
        } else {
          let optionsHtml = "";
          if (item.options) {
            optionsHtml = `
                        <div class="options-grid" id="optionsGrid">
                            ${item.options
                              .map(
                                (opt, i) =>
                                  `<div class="option" data-option="${i}">${opt}</div>`
                              )
                              .join("")}
                        </div>
                    `;
          } else {
            optionsHtml = `<div class="short-answer-label">üìù Short answer question - Type your answer!</div>`;
          }

          let imageHtml = "";
          if (item.image) {
            imageHtml = `<img src="${item.image}" alt="Question image" class="question-image" onerror="this.style.display='none'">`;
          }

          let notesHtml = "";
          if (item.notes) {
            notesHtml = `
                        <div class="host-notes" id="hostNotes">
                            <h4>üîí Host Notes</h4>
                            <p>${item.notes}</p>
                        </div>
                    `;
          }

          content.innerHTML = `
                    <div class="question-container active">
                        <div class="question-header">
                            <span class="question-number">Question ${
                              item.questionNumber
                            }</span>
                            <span class="question-type">${
                              item.questionType === "MC"
                                ? "üîò Multiple Choice"
                                : "üìù Short Answer"
                            }</span>
                        </div>
                        <div class="timer-display countdown" id="timerDisplay">Get Ready...</div>
                        <h2 class="question-text">${item.text}</h2>
                        ${imageHtml}
                        ${optionsHtml}
                        <div class="answer-box" id="answerBox">
                            <h3>‚úÖ Correct Answer</h3>
                            <div class="answer-text">${item.answer}</div>
                        </div>
                        ${notesHtml}
                    </div>
                `;

          syncGameState();
          startPreCountdown();
        }
      }

      function startPreCountdown() {
        let preCount = 3;
        const timerDisplay = document.getElementById("timerDisplay");
        timerDisplay.className = "timer-display countdown";
        timerDisplay.textContent = `Starting in ${preCount}...`;

        db.ref("gameState/timerStatus").set("countdown");
        db.ref("gameState/timerValue").set(preCount);

        countdownInterval = setInterval(() => {
          preCount--;
          if (preCount > 0) {
            timerDisplay.textContent = `Starting in ${preCount}...`;
            db.ref("gameState/timerValue").set(preCount);
          } else {
            clearInterval(countdownInterval);
            startTimer();
          }
        }, 1000);
      }

      function startTimer() {
        const item = quizData[currentIndex];
        if (!item || item.type === "round-title") return;

        clearInterval(timerInterval);
        timeRemaining = parseInt(document.getElementById("currentTimer").value);
        const timerDisplay = document.getElementById("timerDisplay");

        db.ref("gameState/timerStatus").set("running");
        db.ref("gameState/timerValue").set(timeRemaining);
        db.ref("gameState/timerTotal").set(timeRemaining);

        timerDisplay.className = "timer-display";
        timerDisplay.textContent = timeRemaining;

        timerInterval = setInterval(() => {
          timeRemaining--;
          timerDisplay.textContent = timeRemaining;

          db.ref("gameState/timerValue").set(timeRemaining);

          timerDisplay.classList.remove("warning", "danger", "all-answered");
          if (timeRemaining <= 5) {
            timerDisplay.classList.add("danger");
          } else if (timeRemaining <= 10) {
            timerDisplay.classList.add("warning");
          }

          if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            timerDisplay.textContent = "‚è∞ TIME'S UP!";
            timerDisplay.className = "timer-display stopped";
            db.ref("gameState/timerStatus").set("ended");
          }
        }, 1000);
      }

      function manualStartTimer() {
        clearInterval(countdownInterval);
        startTimer();
      }

      function skipTimer() {
        clearInterval(timerInterval);
        clearInterval(countdownInterval);

        if (autoRevealTimeout) {
          clearTimeout(autoRevealTimeout);
          autoRevealTimeout = null;
        }

        const timerDisplay = document.getElementById("timerDisplay");
        if (timerDisplay) {
          timerDisplay.textContent = "‚èπÔ∏è STOPPED";
          timerDisplay.className = "timer-display stopped";
        }
        db.ref("gameState/timerStatus").set("stopped");
      }

      function revealAnswer() {
        const item = quizData[currentIndex];
        if (!item || item.type === "round-title") return;

        answerRevealed = true;
        clearInterval(timerInterval);
        clearInterval(countdownInterval);

        if (autoRevealTimeout) {
          clearTimeout(autoRevealTimeout);
          autoRevealTimeout = null;
        }

        const timerDisplay = document.getElementById("timerDisplay");
        if (timerDisplay) {
          timerDisplay.textContent = "Answer Revealed";
          timerDisplay.className = "timer-display stopped";
        }

        const answerBox = document.getElementById("answerBox");
        if (answerBox) {
          answerBox.classList.add("visible");
        }

        const hostNotes = document.getElementById("hostNotes");
        if (hostNotes) {
          hostNotes.classList.add("visible");
        }

        if (item.options) {
          const options = document.querySelectorAll(".option");
          options.forEach((opt) => {
            if (item.answer.includes(opt.textContent.charAt(0))) {
              opt.classList.add("correct");
            }
          });
        }

        db.ref("gameState/answerRevealed").set(true);
        db.ref("gameState/answer").set(item.answer);
        db.ref("gameState/timerStatus").set("revealed");
      }

      function nextItem() {
        if (currentIndex < quizData.length - 1) {
          currentIndex++;
          const item = quizData[currentIndex];
          if (item.type === "question") {
            db.ref(`answers/${item.questionNumber}`).remove();
          }
          renderCurrentItem();
        }
      }

      function previousItem() {
        if (currentIndex > 0) {
          currentIndex--;
          renderCurrentItem();
        }
      }

      function resetQuiz() {
        if (
          confirm(
            "Are you sure you want to reset the quiz? This will clear all progress and reset scores to zero."
          )
        ) {
          currentIndex = -1;
          answerRevealed = false;
          clearInterval(timerInterval);
          clearInterval(countdownInterval);

          if (autoRevealTimeout) {
            clearTimeout(autoRevealTimeout);
            autoRevealTimeout = null;
          }

          db.ref("gameState").set({
            status: "waiting",
            currentIndex: -1,
          });
          db.ref("answers").remove();

          Object.keys(players).forEach((playerId) => {
            db.ref(`players/${playerId}/score`).set(0);
          });

          // Show quiz selector again
          document.getElementById("quizSelector").style.display = "flex";

          document.getElementById("quizContent").innerHTML = `
                    <div class="welcome-screen" id="welcomeScreen">
                        <h2>Welcome to Trivia Night! üéâ</h2>
                        <p>Quiz loaded with ${
                          quizData.length
                        } items. Wait for players to join, then click "Start Quiz" to begin.</p>
                        <div class="player-count">
                            <span id="playerCountDisplay">${
                              Object.keys(players).length
                            }</span> players connected
                        </div>
                        <br><br>
                        <button class="btn-primary" onclick="startQuiz()" style="font-size: 1.3rem; padding: 20px 40px;">
                            üöÄ Start Quiz
                        </button>
                    </div>
                `;
          document.getElementById("mainControls").style.display = "none";
          document.getElementById("progressFill").style.width = "0%";
          document.getElementById("progressText").textContent =
            "Ready to Start";
        }
      }

      // Render Players
      function renderPlayers() {
        const playerList = document.getElementById("playerList");
        const playerArray = Object.entries(players).map(([id, data]) => ({
          id,
          name: data.name,
          score: data.score || 0,
          online: data.online || false,
        }));

        if (playerArray.length === 0) {
          playerList.innerHTML = '<div class="no-answers">No players yet</div>';
          return;
        }

        const sortedPlayers = playerArray.sort((a, b) => b.score - a.score);

        playerList.innerHTML = sortedPlayers
          .map(
            (player, index) => `
                <div class="player-row ${
                  index === 0 && player.score > 0 ? "leader" : ""
                }">
                    <div class="player-info">
                        <span class="player-name">${
                          index === 0 && player.score > 0 ? "üëë " : ""
                        }${player.name}</span>
                        <span class="player-status">${
                          player.online ? "üü¢ Online" : "‚ö™ Offline"
                        }</span>
                    </div>
                    <div>
                        <span class="player-score">${player.score}</span>
                        <div class="score-buttons">
                            <button class="btn-success score-btn" onclick="addScore('${
                              player.id
                            }', 500)">+500</button>
                            <button class="btn-warning score-btn" onclick="addScore('${
                              player.id
                            }', 250)">+250</button>
                            <button class="btn-danger score-btn" onclick="addScore('${
                              player.id
                            }', -500)">-</button>
                            <button class="btn-secondary score-btn" onclick="removePlayer('${
                              player.id
                            }')">‚úï</button>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function addScore(playerId, points) {
        const currentScore = players[playerId]?.score || 0;
        const newScore = Math.max(0, currentScore + points);
        db.ref(`players/${playerId}/score`).set(newScore);
      }

      function removePlayer(playerId) {
        if (confirm(`Remove ${players[playerId]?.name}?`)) {
          db.ref(`players/${playerId}`).remove();
        }
      }

      function clearAllPlayers() {
        if (confirm("Clear ALL players and scores? This cannot be undone.")) {
          db.ref("players").remove();
          db.ref("answers").remove();
        }
      }

      function syncScoresToPlayers() {
        alert("Scores synced to all players!");
      }

      // Render Answers
      function renderAnswers(allAnswers) {
        currentAnswers = allAnswers;

        const answersList = document.getElementById("answersList");
        const item = quizData[currentIndex];

        if (!item || item.type !== "question") {
          answersList.innerHTML =
            '<div class="no-answers">Waiting for question...</div>';
          return;
        }

        const qNum = item.questionNumber;
        const questionAnswers = allAnswers[qNum] || {};
        const answerArray = Object.entries(questionAnswers).map(
          ([playerId, data]) => ({
            playerId,
            playerName: players[playerId]?.name || "Unknown",
            answer: data.answer,
            time: data.timestamp
              ? new Date(data.timestamp).toLocaleTimeString()
              : "",
          })
        );

        updateAnswerCountDisplay(answerArray.length, getOnlinePlayerCount());

        if (answerArray.length === 0) {
          answersList.innerHTML =
            '<div class="no-answers">Waiting for answers...</div>';
          return;
        }

        answersList.innerHTML = answerArray
          .map(
            (a) => `
                <div class="answer-row">
                    <span class="player">${a.playerName}</span>
                    <span class="answer" title="${a.answer}">${a.answer}</span>
                    <span class="time">${a.time}</span>
                </div>
            `
          )
          .join("");
      }
    </script>
  </body>
</html>
