<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trivia Host Control Panel</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <link rel="stylesheet" href="../shared/styles.css">
  <style>
    /* Kept existing styles, just removed unused ID selectors if any specific styling was attached */
    body { padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
    .main-panel, .sidebar > div { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(66, 165, 245, 0.2); }
    .main-panel { padding: 30px; }
    .sidebar { display: flex; flex-direction: column; gap: 20px; }
    
    .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #e3f2fd; padding-bottom: 20px; }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #1565c0; }
    
    /* Utility */
    .btn-primary { background: #1565c0; color: white; }
    .btn-success { background: #4caf50; color: white; }
    .btn-warning { background: #ff9800; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn-secondary { background: #78909c; color: white; }
    button { padding: 10px 20px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; transition: transform 0.2s; }
    button:hover { transform: translateY(-2px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Quiz Selector */
    .quiz-selector { background: #fff3e0; border: 2px solid #ff9800; border-radius: 12px; padding: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
    .quiz-selector select, .quiz-selector input { padding: 10px; border-radius: 8px; border: 2px solid #ff9800; }
    
    /* Slides */
    .round-title-slide { background: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%); color: white; text-align: center; padding: 40px; border-radius: 15px; min-height: 400px; display: flex; flex-direction: column; justify-content: center; }
    .round-title-slide h2 { color: white; font-size: 3rem; }
    
    /* Question */
    .question-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .question-number { background: #1565c0; color: white; padding: 5px 15px; border-radius: 20px; }
    .timer-display { font-size: 3.5rem; text-align: center; font-weight: bold; color: #1565c0; margin: 20px 0; }
    .timer-display.countdown { color: #ff9800; }
    .timer-display.danger { color: #d32f2f; animation: pulse 0.5s infinite; }
    
    .question-text { font-size: 1.8rem; color: #1565c0; margin-bottom: 20px; }
    .question-image { max-height: 300px; width: 100%; object-fit: contain; border-radius: 10px; margin-bottom: 20px; }
    
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .option { background: #e3f2fd; padding: 15px; border-radius: 10px; color: #1565c0; font-weight: 500; }
    .option.correct { background: #4caf50; color: white; }
    
    .answer-box { background: #e8f5e9; border: 3px solid #4caf50; padding: 20px; border-radius: 15px; text-align: center; margin-top: 20px; }
    .host-notes { background: #fff3e0; border-left: 5px solid #ff9800; padding: 15px; margin-top: 20px; border-radius: 0 10px 10px 0; }

    /* Lists */
    .scroll-list { max-height: 250px; overflow-y: auto; }
    .list-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
    .list-row.leader { background: #fff8e1; }
    .score-btn { padding: 2px 6px; font-size: 0.8rem; margin-left: 2px; }
    
    /* Progress */
    .progress-bar { height: 8px; background: #e3f2fd; border-radius: 4px; overflow: hidden; margin-top: 10px; }
    .progress-fill { height: 100%; background: #1565c0; transition: width 0.3s; }
    
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
  </style>
</head>

<body x-data="triviaHost">
  <div class="container">
    
    <!-- Main Panel -->
    <div class="main-panel">
      <div class="header">
        <h1>üéØ Trivia Night</h1>
        <p>Host Control Panel</p>
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <span class="connection-status" 
                  :class="isConnected ? 'connected' : 'disconnected'"
                  x-text="isConnected ? '‚óè Connected' : '‚óè Connecting...'"></span>
            <button x-show="isAuthenticated" @click="logout()" class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;">Logout</button>
        </div>
      </div>

      <!-- VIEW: Login -->
      <div x-show="!isAuthenticated" style="text-align: center; max-width: 400px; margin: 0 auto;">
        <h2>Host Login</h2>
        <p style="color: #666; margin-bottom: 20px;">Please sign in to manage the quiz.</p>
        
        <form @submit.prevent="login()" style="display: flex; flex-direction: column; gap: 15px;">
            <input type="email" x-model="email" placeholder="Email" required style="padding: 12px; border: 2px solid #e3f2fd; border-radius: 8px;">
            <input type="password" x-model="password" placeholder="Password" required style="padding: 12px; border: 2px solid #e3f2fd; border-radius: 8px;">
            
            <div x-show="loginError" style="color: red; background: #ffebee; padding: 10px; border-radius: 8px;" x-text="loginError"></div>
            
            <button type="submit" class="btn-primary">Sign In</button>
        </form>
      </div>

      <!-- VIEW: Setup (Authenticated) -->
      <div x-show="isAuthenticated && currentView === 'setup'">
        <div class="quiz-selector">
            <label>üìÅ Quiz File:</label>
            <select x-model="filename">
                <option value="EOY-2025.json">2025 Year in Review (EOY-2025.json)</option>
                <option value="sample_quiz.json">Sample Quiz (sample_quiz.json)</option>
                <option value="custom">Custom file...</option>
            </select>
            
            <input type="text" x-model="customFilename" 
                   x-show="filename === 'custom'" 
                   placeholder="Enter filename (e.g. quiz.json)...">
            
            <button @click="loadQuiz()" class="btn-warning" :disabled="loading">
                <span x-show="!loading">Load Quiz</span>
                <span x-show="loading">‚è≥ Loading...</span>
            </button>
        </div>

        <!-- Messages -->
        <div x-show="errorMsg" style="color: red; background: #ffebee; padding: 10px; border-radius: 8px; margin-bottom: 10px;" x-text="errorMsg"></div>
        <div x-show="successMsg" style="color: green; background: #e8f5e9; padding: 10px; border-radius: 8px; margin-bottom: 10px;" x-text="successMsg"></div>

        <!-- Welcome / Start -->
        <div x-show="quizData.length > 0" style="text-align: center; padding: 40px;">
            <h2>Ready to Start!</h2>
            <p><strong x-text="quizData.length"></strong> items loaded.</p>
            <p><strong x-text="playerCount"></strong> players connected.</p>
            <br>
            <button class="btn-primary" style="font-size: 1.5rem; padding: 15px 40px;" @click="startGame()">
                üöÄ Start Game
            </button>
        </div>
      </div>

      <!-- VIEW: Game -->
      <div x-show="isAuthenticated && currentView === 'game'">
        
        <!-- Progress -->
        <div style="text-align: center; color: #78909c; font-size: 0.9rem;">
            Item <span x-text="currentIndex + 1"></span> of <span x-text="quizData.length"></span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" :style="`width: ${progressPercent}%`"></div>
        </div>

        <br>

        <!-- Dynamic Content: Round Title -->
        <template x-if="currentItem && currentItem.type === 'round-title'">
            <div class="round-title-slide">
                <div style="opacity: 0.8; font-size: 1.5rem;">ROUND <span x-text="currentItem.roundNumber"></span></div>
                <h2 x-text="currentItem.title"></h2>
            </div>
        </template>

        <!-- Dynamic Content: Question -->
        <template x-if="currentItem && currentItem.type === 'question'">
            <div>
                <div class="question-header">
                    <span class="question-number">Q<span x-text="currentItem.questionNumber"></span></span>
                    <span class="question-type" x-text="currentItem.questionType === 'MC' ? 'Multiple Choice' : 'Short Answer'"></span>
                </div>

                <!-- Timer -->
                <div class="timer-display" 
                     x-text="timerStatus === 'countdown' ? `Starting in ${timerValue}...` : (timerStatus === 'ended' ? `‚è∞ TIME'S UP!` : timerValue)"
                     :class="{ 'countdown': timerStatus === 'countdown', 'danger': timerStatus === 'running' && timerValue <= 5 }">
                </div>

                <!-- Content -->
                <h2 class="question-text" x-text="currentItem.text"></h2>
                
                <template x-if="currentItem.image">
                    <img :src="currentItem.image" class="question-image" onerror="this.style.display='none'">
                </template>

                <!-- Options Grid (MC) -->
                <template x-if="currentItem.questionType === 'MC'">
                    <div class="options-grid">
                        <template x-for="opt in currentItem.options">
                            <div class="option" 
                                 x-text="opt"
                                 :class="{ 'correct': answerRevealed && currentItem.answer.includes(opt) }"></div>
                        </template>
                    </div>
                </template>
                
                <!-- Short Answer Placeholder -->
                <template x-if="currentItem.questionType === 'SHORT'">
                    <div style="text-align: center; padding: 20px; background: #f5f9ff; border-radius: 10px; margin-bottom: 20px;">
                        üìù Short Answer Question
                    </div>
                </template>

                <!-- Correct Answer Reveal -->
                <div class="answer-box" x-show="answerRevealed">
                    <h3>‚úÖ Correct Answer</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: #1b5e20;" x-text="currentItem.answer"></div>
                </div>

                <!-- Host Notes -->
                <div class="host-notes" x-show="currentItem.notes && answerRevealed">
                    <h4>üîí Host Notes</h4>
                    <p x-text="currentItem.notes"></p>
                </div>

            </div>
        </template>

        <!-- Controls -->
        <div style="margin-top: 30px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
             <button class="btn-warning" @click="stopTimer()" x-show="timerStatus === 'running' || timerStatus === 'countdown'">
                ‚èØÔ∏è Skip Timer
             </button>
             
             <button class="btn-success" @click="revealAnswer()" x-show="!answerRevealed && currentItem.type === 'question'">
                ‚úÖ Reveal Answer
             </button>

             <button class="btn-primary" @click="nextItem()" :disabled="currentIndex >= quizData.length - 1">
                ‚û°Ô∏è Next
             </button>

             <button class="btn-secondary" @click="prevItem()" :disabled="currentIndex <= 0">
                ‚¨ÖÔ∏è Previous
             </button>

             <button class="btn-danger" @click="resetGame()">
                üîÑ Reset Quiz
             </button>
        </div>

      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" x-show="isAuthenticated">
        
        <!-- Timer Settings -->
        <div x-show="currentView === 'game'">
            <h3>‚è±Ô∏è Settings</h3>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <label>Default:</label>
                <input type="number" x-model="defaultTimer" style="width: 60px; padding: 5px;">
            </div>
            
            <label style="display: flex; gap: 10px; align-items: center; font-size: 0.9rem; cursor: pointer;">
                <input type="checkbox" x-model="autoReveal"> Auto-reveal when all answered
            </label>
            
            <button class="btn-primary" style="width: 100%; margin-top: 10px;" @click="startMainTimer()">
                ‚ñ∂Ô∏è Manual Start Timer
            </button>
        </div>

        <!-- Answers Panel -->
        <div x-show="currentView === 'game'">
            <h3>üì• Answers</h3>
            <div style="text-align: center; margin-bottom: 10px; font-weight: bold; background: #e3f2fd; padding: 5px; border-radius: 5px;">
                <span x-text="currentQuestionAnswers.length"></span> / <span x-text="onlinePlayerCount"></span> answered
            </div>
            
            <div class="scroll-list">
                <template x-for="ans in currentQuestionAnswers" :key="ans.playerId">
                    <div class="list-row" :style="ans.isCorrect ? 'background: #dcedc8' : ''">
                        <strong x-text="ans.playerName"></strong>
                        <span x-text="ans.answer"></span>
                    </div>
                </template>
                <div x-show="currentQuestionAnswers.length === 0" style="text-align: center; color: #999; padding: 20px;">
                    Waiting...
                </div>
            </div>
        </div>

        <!-- Scoreboard -->
        <div>
            <h3>üèÜ Scoreboard</h3>
            <div class="scroll-list">
                <template x-for="(player, index) in playerList" :key="player.id">
                    <div class="list-row" :class="{'leader': index === 0 && player.score > 0}">
                        <div>
                            <div style="font-weight: bold;">
                                <span x-show="index === 0 && player.score > 0">üëë</span>
                                <span x-text="player.name"></span>
                            </div>
                            <small x-text="player.online ? 'üü¢ Online' : '‚ö™ Offline'"></small>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #2e7d32;" x-text="player.score"></div>
                            <div>
                                <button class="btn-success score-btn" @click="adjustScore(player.id, 500)">+500</button>
                                <button class="btn-danger score-btn" @click="adjustScore(player.id, -500)">-</button>
                                <button class="btn-secondary score-btn" @click="removePlayer(player.id)">‚úï</button>
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="playerList.length === 0" style="text-align: center; padding: 20px; color: #999;">
                    No players
                </div>
            </div>
            <button class="btn-danger" style="width: 100%; margin-top: 10px;" @click="clearPlayers()">
                üóëÔ∏è Kick All
            </button>
        </div>

    </div>

  </div>

  <!-- Shared Logic -->
  <script src="../shared/firebase-config.js"></script>
  <!-- Application Logic -->
  <script src="host-alpine.js"></script>
</body>
</html>
