<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Editor - Trivia Night</title>
    <link rel="stylesheet" href="../shared/styles.css?v=1.5">
    <style>
        body { padding: 20px; background: #f0f4f8; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .quiz-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .btn { padding: 10px 18px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; }
        .btn-primary { background: #1565c0; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #78909c; color: white; }
        
        .q-editor-card { border-left: 6px solid #1565c0; margin-bottom: 20px; padding: 15px; background: #f9fbff; border-radius: 8px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #455a64; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 6px; box-sizing: border-box; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body x-data="quizEditor">
    <div class="container" x-cloak>
        <div class="header">
            <h1>üìù Quiz Editor</h1>
            <div>
                <a href="host.html" class="btn btn-secondary">‚Üê Back to Host</a>
                <button x-show="isAuthenticated" @click="createNewQuiz()" class="btn btn-success">+ Create New Quiz</button>
            </div>
        </div>

        <div x-show="!isAuthenticated" class="card" style="text-align: center;">
            <h2>Please login as Host</h2>
            <p>You must be authenticated in the Host panel to use the editor.</p>
            <a href="host.html" class="btn btn-primary">Go to Host Panel</a>
        </div>

        <div x-show="isAuthenticated && !editingQuizId" class="card">
            <h3>Your Quizzes</h3>
            <div x-show="Object.keys(quizzes).length === 0" style="padding: 20px; text-align: center; color: #999;">
                No quizzes found in Firebase. 
                <br><br>
                <label class="btn btn-secondary" style="display: inline-block; cursor: pointer;">
                    üì§ Import from JSON file
                    <input type="file" @change="importFromJSON($event)" style="display: none;">
                </label>
            </div>
            <div x-show="Object.keys(quizzes).length > 0" style="margin-bottom: 20px;">
                <label class="btn btn-secondary" style="display: inline-block; cursor: pointer;">
                    üì§ Import another JSON
                    <input type="file" @change="importFromJSON($event)" style="display: none;">
                </label>
            </div>
            <template x-for="(quiz, id) in quizzes" :key="id">
                <div class="quiz-item">
                    <div>
                        <strong style="font-size: 1.2rem;" x-text="quiz.title"></strong>
                        <div style="font-size: 0.8rem; color: #666;" x-text="(quiz.questions ? quiz.questions.length : 0) + ' questions'"></div>
                    </div>
                    <div>
                        <button @click="editQuiz(id)" class="btn btn-primary">Edit</button>
                        <button @click="deleteQuiz(id)" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            </template>
        </div>

        <!-- EDITOR VIEW -->
        <div x-show="editingQuizId" class="card">
            <div class="header" style="border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <input type="text" x-model="currentQuiz.title" style="font-size: 1.5rem; font-weight: bold; width: 60%;">
                <div>
                    <button @click="saveQuiz()" class="btn btn-success" :disabled="loading">
                        <span x-show="!loading">üíæ Save Quiz</span>
                        <span x-show="loading">Saving...</span>
                    </button>
                    <button @click="closeEditor()" class="btn btn-secondary">Close</button>
                </div>
            </div>

            <div x-show="statusMsg" style="background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;" x-text="statusMsg"></div>

            <template x-for="(q, index) in currentQuiz.questions" :key="index">
                <div class="q-editor-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <span style="background: #1565c0; color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem;" x-text="'Question ' + (index + 1)"></span>
                        <button @click="removeQuestion(index)" class="btn btn-danger" style="padding: 2px 8px; font-size: 0.8rem;">Remove</button>
                    </div>

                    <div class="input-group">
                        <label>Question Text</label>
                        <textarea x-model="q.question" rows="2"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Type</label>
                            <select x-model="q.type">
                                <option value="multiple">Multiple Choice</option>
                                <option value="short">Short Answer</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Timer (seconds)</label>
                            <input type="number" x-model="q.timer">
                        </div>
                        <div class="input-group">
                            <label>Category (Optional)</label>
                            <input type="text" x-model="q.category">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Image URL (Optional)</label>
                        <input type="text" x-model="q.image" placeholder="https://...">
                    </div>

                    <!-- Options for Multiple Choice -->
                    <div x-show="q.type === 'multiple'">
                        <label>Options & Correct Answer (Check the correct one)</label>
                        <div class="options-grid">
                            <template x-for="(opt, oIdx) in q.options" :key="oIdx">
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <input type="radio" :name="'correct-' + index" :value="opt" x-model="q.correctAnswer">
                                    <input type="text" x-model="q.options[oIdx]">
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Options for Short Answer -->
                    <div x-show="q.type === 'short'">
                        <label>Accepted Answers (Comma separated)</label>
                        <input type="text" :value="Array.isArray(q.correctAnswer) ? q.correctAnswer.join(', ') : q.correctAnswer" 
                               @input="q.correctAnswer = $event.target.value.split(',').map(s => s.trim())">
                    </div>

                    <div class="input-group" style="margin-top: 10px;">
                        <label>Host Notes (Optional)</label>
                        <textarea x-model="q.notes" rows="1"></textarea>
                    </div>
                </div>
            </template>

            <button @click="addQuestion()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">+ Add Question</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../shared/firebase-config.js"></script>
    <script src="editor-data.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        document.addEventListener('alpine:init', () => {
            if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const auth = firebase.auth();
            Alpine.data('quizEditor', () => window.createEditorData(firebase, db, auth));
        });
    </script>
</body>
</html>
