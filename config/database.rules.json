{
  "rules": {
    "gameState": {
      // Only authenticated users (Host or Players) can see the game state
      ".read": "auth != null",
      // Only the Host (non-anonymous user) can update the game state
      ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
      ".validate": "newData.hasChildren(['status'])"
    },
    "players": {
      // Must be logged in to see the scoreboard
      ".read": "auth != null",
      // Host can manage the entire list (needed for "Kick All")
      ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
      
      "$uid": {
        // Individual fields validation
        "name": { 
          ".write": "auth != null && (auth.uid === $uid || auth.token.firebase.sign_in_provider != 'anonymous')",
          ".validate": "newData.isString() && newData.val().length <= 20" 
        },
        "score": { 
          // CRITICAL: Only the Host can update scores
          ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
          ".validate": "newData.isNumber()" 
        },
        "online": { 
          ".write": "auth != null && (auth.uid === $uid || auth.token.firebase.sign_in_provider != 'anonymous')",
          ".validate": "newData.isBoolean()" 
        },
        "joinedAt": {
          ".write": "auth != null && (auth.uid === $uid || auth.token.firebase.sign_in_provider != 'anonymous')"
        }
      }
    },
    "answers": {
      // SECURITY: Only the Host can read the full answers list to prevent cheating
      ".read": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
      // Host can clear/manage answers
      ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
      
      "$questionId": {
        "$uid": {
          // Players can only submit their own answers
          // SECURITY: Only allow submission if the timer is actually running
          ".write": "auth != null && auth.uid === $uid && root.child('gameState/timerStatus').val() === 'running'",
          ".validate": "newData.hasChildren(['answer', 'timestamp'])"
        }
      }
    }
  }
}